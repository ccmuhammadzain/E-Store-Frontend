<div class="p-6 space-y-6">
  <div class="flex flex-col md:flex-row md:items-center gap-4 justify-between">
    <h2 class="text-2xl font-bold">Customers</h2>
    <div class="flex gap-2 items-center">
      <input
        [(ngModel)]="search"
        placeholder="Search customers..."
        class="px-3 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-yellow-400"
      />
      <button (click)="fetch()" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">
        Refresh
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="text-gray-500 text-sm">Loading customers...</div>
  <div *ngIf="error" class="text-red-600 text-sm">{{ error }}</div>
  <div *ngIf="!loading && !error && filteredCustomers.length === 0" class="text-gray-500 text-sm">
    No customers found.
  </div>

  <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
    <div
      *ngFor="let c of filteredCustomers"
      class="bg-white shadow rounded-lg border border-gray-200 overflow-hidden"
    >
      <button
        (click)="selectCustomer(c)"
        class="w-full text-left p-4 flex justify-between items-start hover:bg-gray-50"
      >
        <div>
          <p class="font-semibold text-gray-800">
            {{ c.customerName || c.username || 'User #' + c.userId }}
          </p>
          <p class="text-xs text-gray-500">ID: {{ c.userId }}</p>
          <p class="text-xs text-gray-500" *ngIf="c.username">Login: {{ c.username }}</p>
          <p class="text-xs text-gray-500" *ngIf="c.phone">📞 {{ c.phone }}</p>
          <p class="text-xs text-gray-500" *ngIf="c.city || c.country">
            📍 {{ c.city }} <span *ngIf="c.city && c.country">,</span> {{ c.country }}
          </p>
        </div>
        <div class="text-right space-y-1">
          <div class="text-sm font-semibold text-green-600">
            ${{ c.totalSpent | number: '1.0-0' }}
          </div>
          <div class="flex gap-1 text-[10px]">
            <span class="px-1.5 py-0.5 rounded bg-green-100 text-green-700"
              >Paid {{ c.paidCount }}</span
            >
            <span class="px-1.5 py-0.5 rounded bg-yellow-100 text-yellow-700"
              >Pend {{ c.pendingCount }}</span
            >
            <span class="px-1.5 py-0.5 rounded bg-red-100 text-red-700"
              >Can {{ c.canceledCount }}</span
            >
          </div>
          <svg
            [ngClass]="{ 'rotate-180': selectedUserId === c.userId }"
            class="w-4 h-4 text-gray-500 transition-transform ml-auto"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </button>
      <div
        *ngIf="selectedUserId === c.userId"
        class="border-t border-gray-200 bg-gray-50 p-3 text-xs"
      >
        <p *ngIf="c.addressLine1" class="mb-2">Address: {{ c.addressLine1 }}</p>
        <table class="w-full text-[11px]">
          <thead>
            <tr class="text-gray-600">
              <th class="text-left py-1">Bill</th>
              <th class="text-right py-1">Total</th>
              <th class="text-left py-1">Status</th>
              <th class="text-left py-1">Paid</th>
              <th class="text-left py-1">Ref</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let b of c.bills" class="border-t border-gray-100 hover:bg-white">
              <td class="py-1">#{{ b.id }}</td>
              <td class="py-1 text-right">${{ b.totalAmount | number: '1.0-0' }}</td>
              <td class="py-1">
                <span [ngClass]="statusClass(b)" class="px-2 py-0.5 rounded font-medium">{{
                  normalizeStatus(b.status)
                }}</span>
              </td>
              <td class="py-1">{{ b.paidAt ? (b.paidAt | date: 'short') : '-' }}</td>
              <td class="py-1 truncate max-w-[80px]" title="{{ b.paymentReference }}">
                {{ b.paymentReference || '-' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
